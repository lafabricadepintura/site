<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paleta de Colores | La Fábrica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --accent: #8bc34a; --bg: #1e1e1e; --card-bg: #2a2a2a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        
        header {
            background: #252525; padding: 1rem 2rem; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.5); position: sticky;
            top: 0; z-index: 1000; margin: 0;
        }
        .logo-main { font-weight: bold; text-decoration: none; color: white; font-size: 1.2rem; }
        nav a { text-decoration: none; color: #bbb; margin-left: 20px; font-weight: 600; font-size: 0.9rem; transition: 0.3s; }
        nav a:hover, nav a.active { color: var(--accent); }

        .search-section {
            background: #151515; padding: 20px; text-align: center;
            position: sticky; top: 57px; z-index: 999; margin: 0;
            border-top: 1px solid #222;
        }

        .search-container { position: relative; max-width: 500px; margin: 0 auto 15px; }
        .search-bar {
            width: 100%; padding: 12px 45px 12px 20px; border-radius: 25px;
            border: 1px solid #333; background: #222; color: white; outline: none;
            font-size: 1rem; box-sizing: border-box;
        }
        
        .clear-search {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            background: #444; color: white; border: none; border-radius: 50%;
            width: 22px; height: 22px; cursor: pointer; display: none;
            font-size: 12px; line-height: 1; font-weight: bold;
        }

        .filter-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; max-width: 1100px; margin: 0 auto; align-items: center; }
        .filter-badge { padding: 8px 18px; border-radius: 20px; background: #333; font-size: 0.8rem; cursor: pointer; border: 1px solid #444; color: #eee; text-transform: capitalize; transition: 0.2s; }
        .filter-badge.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
        
        .btn-reset {
            padding: 8px 15px; border-radius: 20px; background: transparent;
            color: #ff5252; border: 1px solid #ff5252; cursor: pointer;
            font-size: 0.75rem; font-weight: bold; margin-left: 10px;
        }

        .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; min-height: 100vh; }
        .sub-section { margin-bottom: 40px; }
        .sub-title { color: var(--accent); font-size: 1.1rem; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; font-weight: bold; }
        .sub-title::after { content: ""; flex: 1; height: 1px; background: #444; margin-left: 15px; }

        .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .color-card { background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .color-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .color-sample { height: 100px; width: 100%; position: relative; }
        .popular-tag { background: var(--accent); color: #000; font-size: 9px; padding: 2px 5px; font-weight: bold; position: absolute; top: 0; left: 0; border-bottom-right-radius: 5px; }
        .color-info { padding: 10px; text-align: center; }
        .color-name { font-weight: bold; font-size: 0.75rem; display: block; height: 32px; overflow: hidden; line-height: 1.2; }
        .color-id { font-size: 0.65rem; color: #888; margin-top: 5px; display: block; }

        /* MODAL DE ACCIÓN */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; display: none; 
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content { 
            background: #2a2a2a; border-radius: 20px; width: 100%; max-width: 400px; 
            padding: 25px; text-align: center; border: 1px solid #444;
        }
        .modal-color-preview { height: 70px; width: 70px; border-radius: 50%; margin: 0 auto 15px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .modal-btn { 
            display: block; width: 100%; padding: 14px; margin-top: 10px; border-radius: 10px; 
            border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .btn-whatsapp { background: #25d366; color: white; }
        .product-select { 
            width: 100%; padding: 12px; background: #1a1a1a; color: white; 
            border: 1px solid #444; border-radius: 8px; margin: 10px 0;
        }
    </style>
</head>
<body>

<header>
    <a href="../index.html" class="logo-main">LA FÁBRICA <span style="color:var(--accent)">PINTURAS</span></a>
    <nav>
        <a href="../productos/index.html">PRODUCTOS</a>
        <a href="index.html" class="active">COLORES</a>
    </nav>
</header>

<section class="search-section">
    <div class="search-container">
        <input type="text" id="colorSearch" class="search-bar" placeholder="Buscar color o código...">
        <button id="clearBtn" class="clear-search" onclick="clearSearch()">✕</button>
    </div>
    <div class="filter-container" id="badgesSpace"></div>
</section>

<div class="container" id="mainRenderSpace"></div>

<div id="actionModal" class="modal-overlay" onclick="if(event.target==this) closeColorModal()">
    <div class="modal-content">
        <div id="modalPreview" class="modal-color-preview"></div>
        <h2 id="modalTitle" style="margin: 0; font-size: 1.2rem;"></h2>
        <p id="modalCode" style="color: #888; margin: 5px 0 20px; font-size: 0.8rem;"></p>

        <div style="text-align: left; background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid #333;">
            <label style="font-size: 0.65rem; color: var(--accent); font-weight: bold; text-transform: uppercase;">Opción 1: Consultar por Producto</label>
            <select id="productSelect" class="product-select"></select>
            <button class="modal-btn" style="background: var(--accent); color: black;" onclick="orderProduct()">
                Consultar Precio
            </button>
        </div>

        <div style="margin-top: 20px;">
            <label style="font-size: 0.65rem; color: #888; font-weight: bold; text-transform: uppercase;">Opción 2: Consulta Directa</label>
            <button class="modal-btn btn-whatsapp" onclick="sendGeneralColorQuery()">
                Preguntar por este Color
            </button>
        </div>

        <button class="modal-btn" style="background:transparent; color:#666;" onclick="closeColorModal()">Cerrar</button>
    </div>
</div>

<script>
    let colorData = [];
    let productData = [];
    let activeFamily = null;
    let selectedColor = null;

    const simplifyText = (text) => {
        if (!text) return "";
        return text.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    };

    // INICIO: Carga productos y paleta
    function init() {
        Papa.parse("../productos/productos.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(resProd) {
                // Filtramos productos que admitan "Color"
                productData = resProd.data.filter(p => p.Color && p.Color.toLowerCase().includes("color"));
                
                Papa.parse("paleta - Hoja 1.csv", {
                    download: true, header: true, skipEmptyLines: true,
                    complete: function(resCol) {
                        colorData = resCol.data;
                        createFamilyBadges();
                        renderStructured();
                    }
                });
            }
        });
    }

    function getFamily(type) {
        if (!type) return "";
        let t = type.trim();
        if (t.toLowerCase().includes("neutros")) return "Neutros";
        return t.replace(/popular/i, "").replace(/soft/i, "").trim();
    }

    function createFamilyBadges() {
        const familyMap = new Set();
        colorData.forEach(c => {
            const f = getFamily(c.color_type);
            if(f) familyMap.add(f);
        });

        const families = Array.from(familyMap).sort((a, b) => {
            if(a === "Blanco" || a === "Neutros") return -1;
            return a.localeCompare(b);
        });

        const container = document.getElementById("badgesSpace");
        let html = families.map(f =>
            `<div class="filter-badge ${f === activeFamily ? 'active' : ''}" onclick="selectBadge('${f}', this)">${f}</div>`
        ).join('');
        
        html += `<button class="btn-reset" onclick="resetAll()">Limpiar</button>`;
        container.innerHTML = html;
    }

    function selectBadge(f, el) {
        activeFamily = f;
        document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        renderStructured();
    }

    function resetAll() {
        activeFamily = null;
        document.getElementById("colorSearch").value = "";
        createFamilyBadges();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        renderStructured();
    }

    function clearSearch() {
        document.getElementById("colorSearch").value = "";
        renderStructured();
    }

    // RENDERIZADO CON TU LÓGICA DE SUBTIPOS
    function renderStructured() {
        const container = document.getElementById("mainRenderSpace");
        const rawSearch = document.getElementById("colorSearch").value.trim();
        const search = simplifyText(rawSearch);
        const clearBtn = document.getElementById("clearBtn");
        
        clearBtn.style.display = rawSearch.length > 0 ? "block" : "none";
        container.innerHTML = "";

        if (search.length > 0) {
            let baseData = activeFamily ? colorData.filter(c => getFamily(c.color_type) === activeFamily) : colorData;
            const filtrados = baseData.filter(c => {
                const name = simplifyText(c.color_name);
                const id = simplifyText(c.color_id);
                return name.includes(search) || id.includes(search);
            }).slice(0, 300);
            container.innerHTML = `<div class="sub-title">Resultados: ${rawSearch}</div><div class="color-grid">${filtrados.map(c => generateCard(c)).join('')}</div>`;
            return;
        }

        if (activeFamily === null) {
            const populares = colorData.filter(c => c.color_type.toLowerCase().includes("popular"));
            const familiasPop = [...new Set(populares.map(c => getFamily(c.color_type)))].sort();
            container.innerHTML = `<div class="sub-title">Colores Destacados (Más Populares)</div>`;
            familiasPop.forEach(f => {
                const cols = populares.filter(c => getFamily(c.color_type) === f);
                let html = `<div class="sub-section"><div class="sub-title" style="font-size:0.8rem; opacity:0.7">${f}</div><div class="color-grid">`;
                cols.forEach(c => html += generateCard(c));
                html += `</div></div>`;
                container.innerHTML += html;
            });
            return;
        }

        let dataBadge = colorData.filter(c => getFamily(c.color_type) === activeFamily);
        let subtipos = [...new Set(dataBadge.map(c => c.color_type.trim()))].sort((a,b) => {
            const rank = (s) => s.toLowerCase().includes("popular") ? 1 : (s.toLowerCase().includes("soft") ? 3 : 2);
            return rank(a) - rank(b);
        });

        subtipos.forEach(sub => {
            const colores = dataBadge.filter(c => c.color_type.trim() === sub);
            let html = `<div class="sub-section"><div class="sub-title">${sub}</div><div class="color-grid">`;
            colores.forEach(c => html += generateCard(c));
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    function generateCard(c) {
        const esPop = c.color_type && c.color_type.toLowerCase().includes("popular");
        // Escapamos el objeto para el onclick
        const colorJson = JSON.stringify(c).replace(/"/g, '&quot;');
        return `
            <div class="color-card" onclick="openColorModal(${colorJson})" ${esPop ? 'style="border-color:var(--accent)"' : ''}>
                <div class="color-sample" style="background-color: ${c.color_hex}">
                    ${esPop ? '<span class="popular-tag">★ POPULAR</span>' : ''}
                </div>
                <div class="color-info">
                    <span class="color-name">${c.color_name}</span>
                    <span class="color-id">Cód: ${c.color_id}</span>
                </div>
            </div>`;
    }

    // FUNCIONES DEL MODAL
    function openColorModal(color) {
        selectedColor = color;
        document.getElementById('modalTitle').innerText = color.color_name;
        document.getElementById('modalCode').innerText = "Cód: " + color.color_id;
        document.getElementById('modalPreview').style.backgroundColor = color.color_hex;
        
        const select = document.getElementById('productSelect');
        select.innerHTML = productData.map(p => `<option value="${p.Producto}">${p.Producto}</option>`).join('');
        
        document.getElementById('actionModal').style.display = 'flex';
    }

    function closeColorModal() {
        document.getElementById('actionModal').style.display = 'none';
    }

    function orderProduct() {
        const product = document.getElementById('productSelect').value;
        const msg = `Hola La Fábrica! \nQuisiera consultar precio de:\n *${product}*\n Color: *${selectedColor.color_name}*`;
        window.open(`https://wa.me/542214989579?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function sendGeneralColorQuery() {
        const msg = `Hola La Fábrica! Me interesa este color de la paleta digital: \n*${selectedColor.color_name}\n\n¿En qué presentaciones viene?`;
        window.open(`https://wa.me/542214989579?text=${encodeURIComponent(msg)}`, '_blank');
    }

    document.getElementById("colorSearch").oninput = renderStructured;
    window.onload = init;
</script>
</body>
</html>